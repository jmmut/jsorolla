<polymer-element name="jso-xlsx-network-file-open" attributes="selectedMenu">
<template>
    <link rel="stylesheet" href="../jso-style.css">
    <link rel="stylesheet" href="../sortable-table.css">
    <style>
        :host {
            display: block;
            position: absolute;
            box-sizing: border-box;
            background-color: #FFFFFF;
            padding: 20px 60px;

            z-index: 50000;
            top: 170px;

            left: 0;
            right: 0;
            margin-left: auto;
            margin-right: auto;

            width: 50vw;
            border: 0px solid #c6d0da;
            border-width: 1px;
            /*border-top-width: 1px;*/
            transition: all 0.2s;
            box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);
        }

        .title {
            text-align: center;
            font-size: 25px;
            /*color: #666;*/
            padding-bottom: 20px;
            color: #445D76;
        }

        .icon {
            color: #445D76;
            font-size: 50px;
        }

        label {
            display: inline-block;
            width: 100px;
            color: #666;
            margin-top: 10px;
        }

        label::after {
            content: ':'
        }

        .message {
        }

        .bbar {
            height: 40px;
            box-sizing: border-box;
            margin-top: 10px;
        }

        .bbar > * {
            width: 100px;
            float: right;
            margin-left: 10px;
            text-align: center;
        }

        #table {
            overflow-y: auto;
            height: 300px;
            margin: 2px 0 10px 0;
            border: 1px solid #d3d3d3;
        }

        div.button, div.dropdown {
            display: inline-block;
            min-width: 200px;
        }

        #columns .dropdown {
            margin: 0 1px;
        }
    </style>

    <form id="form">
        <div class="title">
            Import a network XLSX file
        </div>

        <label>Select XLSX file</label>

        <div class="button" on-click="{{handleBrowseClick}}">{{fileName}}</div>
        <input type="file" hidden id="fileInput" required on-change="{{handleInputChange}}">
        <br>
        <label>Select sheet</label>

        <div class="dropdown">
            <div tabindex="-1" class="button">
                {{selectedSheet}}
            </div>
            <ul on-click="{{handleSheetMenu}}">
                <template repeat="{{sheet in sheets}}">
                    <li data-value="{{sheet}}">{{sheet}}</li>
                </template>
            </ul>
        </div>
        <br> <br>

        <div id="columns" horizontal layout>
            <div class="dropdown" flex horizontal layout>
                <div tabindex="-1" class="button" flex>
                    {{sourceColumnIndex}}
                </div>
                <ul on-click="{{handleSourceColumnIndex}}">
                    <template repeat="{{index in columnsNumbers}}">
                        <li data-value="{{index}}">{{index}}</li>
                    </template>
                </ul>
            </div>
            <div class="dropdown" flex horizontal layout>
                <div tabindex="-1" class="button" flex>
                    {{relationColumnIndex}}
                </div>
                <ul on-click="{{handleRelationColumnIndex}}">
                    <li data-value="none">none</li>
                    <template repeat="{{index in columnsNumbers}}">
                        <li data-value="{{index}}">{{index}}</li>
                    </template>
                </ul>
            </div>
            <div class="dropdown" flex horizontal layout>
                <div tabindex="-1" class="button" flex>
                    {{targetColumnIndex}}
                </div>
                <ul on-click="{{handleTargetColumnIndex}}">
                    <template repeat="{{index in columnsNumbers}}">
                        <li data-value="{{index}}">{{index}}</li>
                    </template>
                </ul>
            </div>
        </div>

        <sortable-table id="table">
            <sortable-column>Source node</sortable-column>
            <sortable-column>Relation</sortable-column>
            <sortable-column>Target node</sortable-column>
            []
        </sortable-table>

        <div class="message">{{message}}</div>
        <div class="bbar">
            <div class="button" on-click="{{handleCancel}}">Cancel</div>
            <div class="button" on-click="{{handleOk}}">OK</div>
        </div>
    </form>
</template>
<script>
    Polymer({
        created: function () {
            this.fileName = 'Choose file...';
            this.message = ' ';
            this.graph;
            this.adapter;
            this.textAdapter;

            this.selectedSheet = 'Choose a sheet';
            this.sheets;

            this.sourceColumnIndex = 'select';
            this.relationColumnIndex = 'none';
            this.targetColumnIndex = 'select';

            this.columnsNumbers = [];
        },
        handleOk: function () {
            if (this.graph) {
                this.selectedMenu = '';
                this.fire('graph', {graph: this.graph});
            }
        },
        handleCancel: function () {
            this.selectedMenu = '';
        },
        handleBrowseClick: function (e) {
            this.$.fileInput.click();
        },
        handleInputChange: function (e) {
            var me = this;
            var inputFile = this.$.fileInput.files[0];
            this.fileName = inputFile.name;
            this.message = '';

            if (this.$.form.checkValidity()) {
                this.adapter = new XLSXNetworkDataAdapter({
                    dataSource: new FileDataSource({file: inputFile, type: 'binary'}),
                    separator: this.parseCharacter,
                    handlers: {
                        'data:load': function (event) {
                            me.adapter = event.sender;
                            me.processWorkbook(event.sender);
                        },
                        'error:parse': function (event) {
                            me.message = event.errorMsg;
                        }
                    }
                });
            }
        },

        processWorkbook: function () {
            this.sheets = Object.keys(this.adapter.xlsx.Sheets);
        },
        handleSheetMenu: function (e) {
            var me = this;
            this.selectedSheet = e.target.dataset.value;

            this.sourceColumnIndex = 'select';
            this.relationColumnIndex = 'none';
            this.targetColumnIndex = 'select';
            this.$.table.data = [];

            var csv = this.adapter.parseSheet(this.selectedSheet);

            var textAdapter = new TextNetworkDataAdapter({
                dataSource: new StringDataSource(csv),
                separator: ',',
                handlers: {
                    'data:load': function (event) {
                        me.processColumns(event.sender);
                    },
                    'error:parse': function (event) {
                        me.message = event.errorMsg;
                    }
                }
            });
        },
        handleSourceColumnIndex: function (e) {
            if (e.target.dataset.value) {
                this.sourceColumnIndex = parseInt(e.target.dataset.value);
                this.processColumnNumbers();
            }
        },
        handleRelationColumnIndex: function (e) {
            if (e.target.dataset.value) {
                this.relationColumnIndex = e.target.dataset.value;
                this.processColumnNumbers();

            }
        },
        handleTargetColumnIndex: function (e) {
            if (e.target.dataset.value) {
                this.targetColumnIndex = parseInt(e.target.dataset.value);
                this.processColumnNumbers();
            }
        },
        processColumns: function (textAdapter) {
            this.textAdapter = textAdapter;
            this.columnsNumbers = [];
            for (var i = 0; i < textAdapter.columnLength; i++) {
                this.columnsNumbers.push(i + 1);
            }
        },
        processColumnNumbers: function () {
            if (this.textAdapter) {
                if (!(isNaN(this.sourceColumnIndex)) && !(isNaN(this.targetColumnIndex))) {
                    var relationDefaultName = 'none';
                    var columnIndex;
                    if (this.relationColumnIndex === 'none') {
                        columnIndex = -1;
                    } else {
                        columnIndex = this.relationColumnIndex - 1;
                    }
                    var graph = this.textAdapter.parseColumns(this.sourceColumnIndex - 1, this.targetColumnIndex - 1, columnIndex, relationDefaultName);
                    this.processData(graph);
                }
            }

        },
        processData: function (graph) {
            try {
//                    this.content = graph; //para el onOK.notify event
                var verticesLength = graph.vertices.length;
                var edgesLength = graph.edges.length;

                var edges = graph.edges;
                var data = [];
                for (var i = 0; i < edges.length; i++) {
                    var edge = edges[i];
                    data.push([edge.source.id, edge.relation, edge.target.id]);
                }

                this.$.table.data = data;

                this.message = 'File loaded sucessfully, Vertices:' + verticesLength + ', edges:' + edgesLength + '';

                this.graph = graph;
            } catch (e) {
                this.message = 'File not valid. ';
                console.log(e)
            }
        }
    });
</script>
</polymer-element>